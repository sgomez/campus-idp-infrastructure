version: "3.6"

x-rabbitmq-variables: &rabbitmq-variables
  RABBITMQ_DEFAULT_USER: "admin"
  RABBITMQ_DEFAULT_PASS: "!ChangeMe!"
  RABBITMQ_ERLANG_COOKIE: "!ChangeMe!"
  RABBITMQ_DEFAULT_VHOST: "/"

x-mongodb-variables: &mongodb-variables
  MONGO_INITDB_DATABASE: "idpapi"
  MONGO_INITDB_ROOT_USERNAME: "admin"
  MONGO_INITDB_ROOT_PASSWORD: "!ChangeMe!"
  ME_CONFIG_MONGODB_ADMINUSERNAME: "admin"
  ME_CONFIG_MONGODB_ADMINPASSWORD: "!ChangeMe!"

x-api-variables: &api-variables
  SERVERNAME: "api"
  MONGO_IDPAPI_USERNAME: "idpapi"
  MONDO_IDPAPI_PASSWORD: "!ChangeMe!"

services:
  gui:
    build:
      context: docker/gui/
    image: campusidp-gui:latest
    ports:
      - target: 3000
        published: 8000
        mode: host

  api:
    hostname: api
    build:
      context: docker/api
    image: campusidp-api:latest
    environment:
      <<: *rabbitmq-variables
      <<: *mongodb-variables
      <<: *api-variables
    depends_on:
      - mongo
      - rabbitmq
    ports:
      - target: 2456
        published: 2456
        protocol: tcp
        mode: host
      - target: 4000
        published: 4000
        protocol: tcp
        mode: host

  worker:
    build:
      context: docker/worker
    image: campusidp-worker:latest
    restart: always
    environment:
      <<: *rabbitmq-variables
    depends_on:
      - rabbitmq
    volumes:
      - ./logs:/opt/ansible-shibboleth/worker/logs

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      <<: *rabbitmq-variables
      RABBITMQ_USE_LONGNAME: "false"
    ports:
      - target: 15672
        published: 8080
        mode: host
      - target: 5672
        published: 5672
        mode: host

  mongo:
    image: mongo:4.0
    environment:
      <<: *mongodb-variables
      <<: *api-variables
    volumes:
      - data:/data/db
      - ./docker/mongo:/docker-entrypoint-initdb.d
    ports:
      - target: 27017
        published: 27017
        protocol: tcp
        mode: host

  mongo-express:
    image: mongo-express
    environment:
      <<: *mongodb-variables
    restart: always
    ports:
      - 8081:8081

volumes:
  data:
    driver: local
